<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Cámara</title>
<link rel="icon" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi_hzdAeGD1r9dY8htUSrH5WyLWPR4Xw3G390Nxfsl5zSXl9rnEuK7LG3GRHlvhFyhpzP2vyix-QncMJxnyx0bBimWxKk7ZU1-lzG410NMxtPXH4H7R6QxoUcEJ7uPisB2VyWuANC5O31ArDgOgNgnnQRAWV_TPhB-F7d8DuqWo3PRTNi_vPQ2oHJBi3vp0/s1890/logo.png" type="image/png">
<style>
  :root{--bg:#0a0a0a;--ink:#eaeaea;--line:#1a1a1a;--ring:#2b2b2b}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{background:var(--bg);color:var(--ink);font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;overflow:hidden}
  .shell{height:100svh;padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);display:grid;grid-template-rows:56px 1fr 88px;gap:8px}
  header{display:flex;align-items:center;justify-content:space-between;padding:0 14px;border-bottom:1px solid var(--line);gap:10px}
  .left,.right{display:flex;align-items:center;gap:10px}
  .btn,.select{font-size:12px;color:var(--ink);background:#111;border:1px solid var(--ring);border-radius:10px;height:32px;padding:0 10px;user-select:none}
  .btn:active{transform:translateY(1px)}
  .btn.icon{display:flex;align-items:center;justify-content:center;width:36px;padding:0}
  .btn.tgl{display:flex;align-items:center;justify-content:center;gap:6px;min-width:96px}
  .btn.on{background:#1b1b1b;border-color:#3a3a3a;box-shadow:inset 0 0 0 1px rgba(255,255,255,.03)}
  .stage{display:grid;place-items:center;padding:0 10px}
  .frame{position:relative;max-width:100%;height:100%;display:grid;place-items:center}
  video#video{display:block;max-height:100%;max-width:80%;filter:grayscale(1) contrast(1.1);outline:1px solid var(--line);border-radius:14px;background:#0b0b0b}
  @media (min-width:900px){video#video{max-width:56%}}
  canvas#visor{display:none;max-height:100%;max-width:80%;outline:1px solid var(--line);border-radius:14px;background:#0b0b0b}
  @media (min-width:900px){canvas#visor{max-width:56%}}
  .bar{display:grid;place-items:center}
  .shutter{width:76px;height:76px;border-radius:999px;position:relative;cursor:pointer;border:1px solid var(--ring);background:radial-gradient(circle at 50% 50%,#1b1b1b 42%,#121212 43%) no-repeat,radial-gradient(circle at 50% 50%,#2a2a2a 30%,#1a1a1a 31%) no-repeat;background-size:100% 100%,78% 78%;background-position:center;box-shadow:0 10px 26px rgba(0,0,0,.5)}
  .shutter:active{transform:scale(.98)}
  .shutter::after{content:'';position:absolute;inset:8px;border-radius:999px;border:2px solid rgba(255,255,255,.06)}
  .sheet{position:fixed;left:0;right:0;bottom:0;background:#0f0f0f;border-top:1px solid var(--ring);box-shadow:0 -20px 40px rgba(0,0,0,.4);padding:14px 12px calc(14px + env(safe-area-inset-bottom));display:none;z-index:50}
  .sheet .row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  .chip{border:1px solid var(--ring);border-radius:999px;padding:8px 12px;background:#131313;color:#eaeaea;font-size:12px;cursor:pointer}
  .chip.active{background:#ffffff;color:#000;border-color:#ffffff}
  .sheet .actions{display:flex;justify-content:center;gap:8px;margin-top:10px}
  .hidden{display:none!important}
</style>
</head>
<body>
  <div class="shell">
    <header>
      <div class="left">
        <button id="backBtn" class="btn icon" title="Volver" aria-label="Volver">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M15 18l-6-6 6-6"></path></svg>
        </button>
      </div>
      <div class="right">
        <button id="mirrorBtn" class="btn tgl" aria-pressed="false" title="Espejar">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 3v18"></path><path d="M9 8l-4 4 4 4"></path><path d="M15 8l4 4-4 4"></path></svg>
          <span>Espejar</span>
        </button>
        <button id="toggleCam" class="btn" title="Cambiar cámara">Cambiar cámara</button>
      </div>
    </header>

    <div class="stage">
      <div class="frame">
        <video id="video" playsinline muted autoplay></video>
        <canvas id="visor"></canvas>
      </div>
    </div>

    <div class="bar"><button id="shutterBtn" class="shutter" aria-label="Capturar"></button></div>
  </div>

  <div id="sheet" class="sheet" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="row" id="rampRow">
      <button class="chip active" data-ramp="  .,,;;ccooaaddqqWWMM@@">Bloques</button>
      <button class="chip" data-ramp=" 0123456789">Números</button>
      <button class="chip" data-ramp=" .:-=+*#%@">Básico</button>
      <button class="chip" data-ramp=" .'`^\",:;Il!i~+_-?][}{1)(|\\tfjrxnuvczXYUJCLQ0OZmwqpdbkhao*#MW&8%B@$">Denso</button>
    </div>
    <div class="actions">
      <button id="applyBtn" class="btn">Aplicar</button>
      <button id="retakeBtn" class="btn">Volver a cámara</button>
    </div>
  </div>

<script>
(() => {
  const video = document.getElementById('video');
  const visor = document.getElementById('visor');
  const vctx  = visor.getContext('2d',{alpha:false});
  const shutterBtn = document.getElementById('shutterBtn');
  const sheet = document.getElementById('sheet');
  const rampRow = document.getElementById('rampRow');
  const backBtn = document.getElementById('backBtn');
  const mirrorBtn = document.getElementById('mirrorBtn');
  const toggleCamBtn = document.getElementById('toggleCam');
  const applyBtn = document.getElementById('applyBtn');
  const retakeBtn = document.getElementById('retakeBtn');

  let currentRamp = "  .,,;;ccooaaddqqWWMM@@";
  let facing = 'environment';
  let mirrored = false;
  let shot = null; // ImageData del frame congelado

  function selectChip(el){
    rampRow.querySelectorAll('.chip').forEach(c=>c.classList.remove('active'));
    el.classList.add('active');
    currentRamp = el.dataset.ramp;
  }

  rampRow.addEventListener('click', (e)=>{
    const btn = e.target.closest('.chip');
    if(btn) selectChip(btn);
  });

  backBtn.onclick = ()=>{ location.href='/' };

  mirrorBtn.onclick = ()=>{
    mirrored = !mirrored;
    mirrorBtn.classList.toggle('on', mirrored);
    mirrorBtn.setAttribute('aria-pressed', String(mirrored));
    video.style.transform = mirrored ? 'scaleX(-1)' : 'none';
    if(shot) drawASCII(); // si ya hay captura, re-render
  };

  toggleCamBtn.onclick = ()=>{
    facing = (facing==='environment'?'user':'environment');
    startCamera();
  };

  function constraints(){
    return [
      {video:{facingMode:{exact:facing},width:{ideal:1920},height:{ideal:1080}},audio:false},
      {video:{facingMode:{ideal:facing},width:{ideal:1280},height:{ideal:720}},audio:false},
      {video:{facingMode:facing},audio:false}
    ];
  }

  async function startCamera(){
    try{
      if(video.srcObject){
        video.srcObject.getTracks().forEach(t=>t.stop());
      }
      let stream=null;
      for(const c of constraints()){
        try{ stream = await navigator.mediaDevices.getUserMedia(c); break; }catch{}
      }
      if(!stream) throw new Error('No stream');
      video.srcObject = stream;
      await video.play();
      shot = null;
      visor.style.display='none';
      video.style.display='block';
    }catch(e){
      console.warn(e);
    }
  }

  function openSheet(open){
    sheet.style.display = open ? 'block' : 'none';
    sheet.setAttribute('aria-hidden', String(!open));
  }

  shutterBtn.onclick = ()=>{
    captureFrame();
    openSheet(true);
  };

  applyBtn.onclick = ()=>{
    drawASCII();
  };

  retakeBtn.onclick = ()=>{
    openSheet(false);
    shot = null;
    startCamera();
  };

  function captureFrame(){
    const w = video.videoWidth || 640;
    const h = video.videoHeight || 480;
    const tmp = document.createElement('canvas');
    tmp.width = w; tmp.height = h;
    const tctx = tmp.getContext('2d',{willReadFrequently:true});
    if(mirrored){
      tctx.translate(w,0); tctx.scale(-1,1);
    }
    tctx.drawImage(video,0,0,w,h);
    shot = tctx.getImageData(0,0,w,h);
    video.style.display='none';
    visor.style.display='block';
  }

  function drawASCII(){
    if(!shot) return;
    // Elegimos una rejilla liviana para PC: ~120 columnas aprox
    const targetCols = Math.min(120, Math.floor((shot.width)/10));
    const ratio = shot.height/shot.width;
    const targetRows = Math.max(1, Math.round(targetCols*ratio*0.55)); // compensar alto de línea
    const s = sample(shot, targetCols, targetRows);

    const fontPx = 12;
    const charW = fontPx * 0.6;
    const lineH = Math.ceil(fontPx * 1.0);

    visor.width  = Math.ceil(targetCols * charW);
    visor.height = Math.ceil(targetRows * lineH);

    vctx.fillStyle = '#0a0a0a';
    vctx.fillRect(0,0,visor.width,visor.height);
    vctx.fillStyle = '#eaeaea';
    vctx.font = `${fontPx}px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace`;
    vctx.textBaseline = 'top';

    const ramp = currentRamp;
    const n = ramp.length - 1;

    for(let y=0;y<targetRows;y++){
      let sx = 0, sy = y * lineH;
      for(let x=0;x<targetCols;x++){
        const i = (y*targetCols + x)*4;
        const r = s[i], g = s[i+1], b = s[i+2];
        // luminancia + conversión a BN ya vienen de sample() con grayscale
        const lum = r; // r==g==b
        const idx = Math.max(0, Math.min(n, Math.round((lum/255)*n)));
        const ch = ramp[idx];
        vctx.fillText(ch, sx, sy);
        sx += charW;
      }
    }
  }

  function sample(imgData, cols, rows){
    const srcW = imgData.width, srcH = imgData.height;
    const off = document.createElement('canvas');
    off.width = cols; off.height = rows;
    const octx = off.getContext('2d',{willReadFrequently:true});
    const tmp = document.createElement('canvas');
    tmp.width = srcW; tmp.height = srcH;
    const tctx = tmp.getContext('2d');
    const d = tctx.createImageData(imgData.width, imgData.height);
    d.data.set(imgData.data);
    tctx.putImageData(d,0,0);
    octx.imageSmoothingEnabled = false;
    octx.drawImage(tmp,0,0,cols,rows);

    // Pasar a blanco y negro con contraste leve (offline, súper liviano)
    const data = octx.getImageData(0,0,cols,rows);
    const a = data.data;
    for(let i=0;i<a.length;i+=4){
      const r=a[i], g=a[i+1], b=a[i+2];
      let lum = (0.2126*r + 0.7152*g + 0.0722*b);
      lum = ((lum-128)*1.1)+128; // contraste suave
      lum = lum<0?0:lum>255?255:lum;
      a[i]=a[i+1]=a[i+2]=lum;
    }
    return a;
  }

  startCamera();
})();
</script>
</body>
</html>
