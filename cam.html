<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Cámara</title>
<link rel="icon" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi_hzdAeGD1r9dY8htUSrH5WyLWPR4Xw3G390Nxfsl5zSXl9rnEuK7LG3GRHlvhFyhpzP2vyix-QncMJxnyx0bBimWxKk7ZU1-lzG410NMxtPXH4H7R6QxoUcEJ7uPisB2VyWuANC5O31ArDgOgNgnnQRAWV_TPhB-F7d8DuqWo3PRTNi_vPQ2oHJBi3vp0/s1890/logo.png" type="image/png">
<style>
  :root{--bg:#0a0a0a;--ink:#eaeaea;--line:#1a1a1a;--ring:#2b2b2b;--max:1100px;--composer-h:0px;--red:#e02424;--red-2:#ff6b6b}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{background:var(--bg);color:var(--ink);font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;overflow:hidden}
  .shell{height:100svh;padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);display:grid;grid-template-rows:56px 1fr 88px;gap:8px}
  header{display:flex;align-items:center;justify-content:space-between;padding:0 14px;border-bottom:1px solid var(--line);gap:10px;position:relative}
  .left,.right{display:flex;align-items:center;gap:10px}
  .btn,.select{font-size:12px;color:var(--ink);background:#111;border:1px solid var(--ring);border-radius:10px;height:32px;padding:0 10px;user-select:none}
  .btn:active{transform:translateY(1px)}
  .btn.icon{display:flex;align-items:center;justify-content:center;width:36px;padding:0}
  .btn.tgl{display:flex;align-items:center;justify-content:center;gap:6px;min-width:96px}
  .btn.on{background:#1b1b1b;border-color:#3a3a3a;box-shadow:inset 0 0 0 1px rgba(255,255,255,.03)}
  .btn.tgl svg{width:16px;height:16px}
  .select{appearance:none}
  .stage{display:grid;place-items:center;padding:0 10px}
  canvas#visor{display:block;width:80%;height:auto;max-height:calc(100% - 4px);outline:1px solid var(--line);border-radius:14px;background:#0b0b0b}
  @media (min-width:900px){canvas#visor{width:56%}}
  .bar{display:grid;place-items:center}
  .shutter{width:76px;height:76px;border-radius:999px;position:relative;cursor:pointer;border:1px solid var(--ring);background:radial-gradient(circle at 50% 50%,#1b1b1b 42%,#121212 43%) no-repeat,radial-gradient(circle at 50% 50%,#2a2a2a 30%,#1a1a1a 31%) no-repeat;background-size:100% 100%,78% 78%;background-position:center;box-shadow:0 10px 26px rgba(0,0,0,.5)}
  .shutter:active{transform:scale(.98)}
  .shutter::after{content:'';position:absolute;inset:8px;border-radius:999px;border:2px solid rgba(255,255,255,.06)}
  .composer{position:fixed;left:0;right:0;bottom:0;z-index:55;background:#fff;color:#171717;border-top:1px solid var(--line);padding:10px 12px calc(10px + env(safe-area-inset-bottom));box-shadow:0 -6px 30px rgba(0,0,0,.06);display:none}
  .composer .row{max-width:var(--max);margin:0 auto;display:flex;align-items:center;gap:8px;justify-content:center}
  .composer textarea{flex:1;max-width:720px;border:1px solid var(--line);border-radius:12px;padding:12px 12px;font-size:16px;outline:none;min-width:0;background:#fff;color:#171717;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;height:44px;min-height:44px;max-height:44px;resize:none;overflow:auto;white-space:pre-wrap}
  .composer .send{border:none;background:#111;color:#fff;border-radius:12px;padding:12px 16px;font-weight:700;cursor:pointer;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .composer .preview{max-width:var(--max);margin:6px auto 0;display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
  .chip{border:1px solid var(--line);border-radius:10px;padding:6px 8px;font-size:.85rem;background:#fff;color:#171717}
  .toast{position:fixed;left:50%;top:12px;transform:translateX(-50%);background:var(--red);color:#fff;border:1px solid var(--red-2);border-radius:10px;padding:10px 14px;z-index:9999;box-shadow:0 10px 28px rgba(0,0,0,.3);display:none;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  .toast.show{display:block}
  .menu{position:absolute;right:10px;top:48px;background:#0f0f0f;border:1px solid var(--ring);border-radius:12px;box-shadow:0 18px 40px rgba(0,0,0,.5);padding:8px;display:none;z-index:100}
  .menu.show{display:grid;gap:6px}
  .menu .item{display:flex;align-items:center;gap:8px;border:1px solid var(--ring);background:#131313;color:#eaeaea;border-radius:10px;padding:8px 10px;font-size:12px;cursor:pointer}
  .menu .item:active{transform:translateY(1px)}
  .menu .item.active{background:#ffffff;color:#000;border-color:#ffffff}
  video,canvas#off{display:none}
</style>
</head>
<body>
  <div class="shell">
    <header>
      <div class="left">
        <button id="backBtn" class="btn icon" title="Volver" aria-label="Volver">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M15 18l-6-6 6-6"></path></svg>
        </button>
      </div>
      <div class="right">
        <button id="mirrorBtn" class="btn tgl" aria-pressed="false" title="Espejar">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 3v18"></path><path d="M9 8l-4 4 4 4"></path><path d="M15 8l4 4-4 4"></path></svg>
          <span>Espejar</span>
        </button>
        <select id="ramp" class="select" title="Ramp">
          <option value=" .:-=+*#%@">Ramp: Básico</option>
          <option value=" .'`^\",:;Il!i~+_-?][}{1)(|\\tfjrxnuvczXYUJCLQ0OZmwqpdbkhao*#MW&8%B@$">Ramp: Denso</option>
          <option value=" 0123456789">Ramp: Números</option>
          <option value="  .,,;;ccooaaddqqWWMM@@" selected>Ramp: Bloques</option>
        </select>
        <button id="toggleCam" class="btn" title="Cambiar cámara">Cambiar cámara</button>
        <button id="settingsBtn" class="btn icon" title="Ajustes" aria-haspopup="true" aria-expanded="false">
          <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09A1.65 1.65 0 0 0 8 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 3.4 15a1.65 1.65 0 0 0-1.51-1H2a2 2 0 1 1 0-4h.09A1.65 1.65 0 0 0 3.4 8a1.65 1.65 0 0 0-.33-1.82l-.06-.06A2 2 0 1 1 5.84 3.3l.06.06A1.65 1.65 0 0 0 7.72 3a1.65 1.65 0 0 0 1-1.51V1a2 2 0 1 1 4 0v.09A1.65 1.65 0 0 0 15 3.4a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 21 8.6c0 .6.23 1.18.64 1.6.42.41.96.64 1.6.64"></path></svg>
        </button>
        <div id="settingsMenu" class="menu" role="menu" aria-hidden="true">
          <button class="item" id="brightTgl" role="menuitem" aria-pressed="false">Aumentar luminosidad</button>
          <button class="item" id="contrastTgl" role="menuitem" aria-pressed="false">Aumentar contraste</button>
          <button class="item" id="darkTgl" role="menuitem" aria-pressed="false">Oscurecer</button>
        </div>
      </div>
    </header>
    <div class="stage"><canvas id="visor"></canvas></div>
    <div class="bar"><button id="shutterBtn" class="shutter" aria-label="Capturar"></button></div>
  </div>
  <div class="composer" id="composer">
    <div class="row">
      <textarea id="composeTxt" placeholder="Escribí algo… (podés usar #hashtags)"></textarea>
      <button class="send" id="sendBtn">Publicar</button>
    </div>
    <div class="preview" id="composePreview"></div>
  </div>
  <div class="toast" id="toast"></div>
  <video id="video" playsinline muted autoplay></video>
  <canvas id="off"></canvas>
<script>
(() => {
  const visor=document.getElementById('visor');
  const vctx=visor.getContext('2d',{alpha:false});
  const video=document.getElementById('video');
  const off=document.getElementById('off');
  const octx=off.getContext('2d',{willReadFrequently:true});
  const backBtn=document.getElementById('backBtn');
  const mirrorBtn=document.getElementById('mirrorBtn');
  const rampEl=document.getElementById('ramp');
  const toggleCamBtn=document.getElementById('toggleCam');
  const shutterBtn=document.getElementById('shutterBtn');
  const composer=document.getElementById('composer');
  const composeTxt=document.getElementById('composeTxt');
  const sendBtn=document.getElementById('sendBtn');
  const toast=document.getElementById('toast');
  const settingsBtn=document.getElementById('settingsBtn');
  const settingsMenu=document.getElementById('settingsMenu');
  const brightTgl=document.getElementById('brightTgl');
  const contrastTgl=document.getElementById('contrastTgl');
  const darkTgl=document.getElementById('darkTgl');

  let rafId=null,frozen=false,asciiText='';

  const isMobile=/iPhone|Android.+Mobile/i.test(navigator.userAgent)||navigator.userAgentData?.mobile||window.matchMedia('(max-width: 820px)').matches;
  const qualityScale=isMobile?2:1.25;

  const state={ramp:rampEl.value,mirror:false,sw:640,sh:480,fontPx:10,charW:6,lineH:10,facing:'environment',brightness:0,contrast:1,fx:{bright:false,contrast:false,dark:false}};

  const L=(r,g,b)=>0.2126*r+0.7152*g+0.0722*b;
  const clamp=(v,min,max)=>v<min?min:v>max?max:v;

  function targets(){
    if(isMobile) return {cols:160,rows:96};
    return {cols:140,rows:80};
  }

  function recomputeFX(){
    state.brightness=(state.fx.bright?40:0)+(state.fx.dark?-40:0);
    state.contrast=state.fx.contrast?1.35:1;
    if(video.readyState>=2){drawFrom(video);if(frozen)asciiText=asciiFrom(video)}
  }
  function tone(lum){let v=lum+state.brightness;v=((v-128)*state.contrast)+128;return clamp(v,0,255)}
  const pick=(lum,ramp)=>{const n=ramp.length-1;let i=clamp(Math.round((lum/255)*n),0,n);return ramp[i]};

  function setInternalSize(w,h){
    state.sw=Math.max(1,Math.floor(w));
    state.sh=Math.max(1,Math.floor(h));
    visor.width=state.sw;
    visor.height=state.sh;
    calibrateFont();
  }

  function calibrateFont(){
    const t=targets();
    let px=12;
    vctx.font=`${px}px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace`;
    let cw=vctx.measureText('M').width, ch=Math.ceil(px*1.0);
    while((state.sw/cw)<t.cols || (state.sh/ch)<t.rows){
      px=Math.max(5,px-1);
      vctx.font=`${px}px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace`;
      cw=vctx.measureText('M').width;
      ch=Math.ceil(px*1.0);
      if(px===5) break;
    }
    state.fontPx=px;
    state.charW=cw;
    state.lineH=ch;
    vctx.textBaseline='top';
    vctx.imageSmoothingEnabled=false;
  }

  function grid(){return{cols:Math.max(8,Math.floor(state.sw/state.charW)),rows:Math.max(8,Math.floor(state.sh/state.lineH))}}

  function sample(source){
    const {cols,rows}=grid();
    off.width=cols; off.height=rows;
    octx.save();
    octx.imageSmoothingEnabled=false;
    octx.clearRect(0,0,cols,rows);
    if(state.mirror){octx.translate(cols,0);octx.scale(-1,1)}
    octx.drawImage(source,0,0,cols,rows);
    octx.restore();
    return octx.getImageData(0,0,cols,rows);
  }

  function drawFrom(source){
    const img=sample(source),data=img.data;
    const {cols,rows}=grid(),ramp=state.ramp;
    vctx.fillStyle='#0a0a0a';
    vctx.fillRect(0,0,visor.width,visor.height);
    vctx.fillStyle=getComputedStyle(document.documentElement).getPropertyValue('--ink')||'#eaeaea';
    vctx.font=`${state.fontPx}px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace`;
    for(let y=0;y<rows;y++){
      let sx=0, sy=y*state.lineH;
      for(let x=0;x<cols;x++){
        const i=(y*cols+x)*4;
        const lum=tone(L(data[i],data[i+1],data[i+2]));
        const ch=pick(lum,ramp);
        vctx.fillText(ch,sx,sy);
        sx+=state.charW;
      }
    }
  }

  function asciiFrom(source){
    const img=sample(source),data=img.data;
    const {cols,rows}=grid(),ramp=state.ramp;
    let out='';
    for(let y=0;y<rows;y++){
      let line='';
      for(let x=0;x<cols;x++){
        const i=(y*cols+x)*4;
        const lum=tone(L(data[i],data[i+1],data[i+2]));
        line+=pick(lum,ramp);
      }
      out+=line+(y<rows-1?'\n':'');
    }
    return out;
  }

  function asciiWithMarkers(s){return s.split('\n').map(line=>'X*****'+line+'*****X').join('\n')}

  function loop(){rafId=requestAnimationFrame(loop);if(video.readyState>=2)drawFrom(video)}

  rampEl.onchange=()=>{state.ramp=rampEl.value;if(video.readyState>=2){drawFrom(video);if(frozen)asciiText=asciiFrom(video)}};
  toggleCamBtn.onclick=()=>{state.facing=state.facing==='environment'?'user':'environment';startCamera(state.facing)};
  mirrorBtn.onclick=()=>{state.mirror=!state.mirror;mirrorBtn.classList.toggle('on',state.mirror);mirrorBtn.setAttribute('aria-pressed',String(state.mirror));if(video.readyState>=2){drawFrom(video);if(frozen)asciiText=asciiFrom(video)}};

  settingsBtn.onclick=(e)=>{e.stopPropagation();const shown=settingsMenu.classList.toggle('show');settingsBtn.setAttribute('aria-expanded',String(shown));settingsMenu.setAttribute('aria-hidden',String(!shown))};
  document.addEventListener('click',(e)=>{if(!settingsMenu.contains(e.target)&&e.target!==settingsBtn){settingsMenu.classList.remove('show');settingsBtn.setAttribute('aria-expanded','false');settingsMenu.setAttribute('aria-hidden','true')}});

  brightTgl.onclick=()=>{state.fx.bright=!state.fx.bright;brightTgl.classList.toggle('active',state.fx.bright);brightTgl.setAttribute('aria-pressed',String(state.fx.bright));recomputeFX()};
  contrastTgl.onclick=()=>{state.fx.contrast=!state.fx.contrast;contrastTgl.classList.toggle('active',state.fx.contrast);contrastTgl.setAttribute('aria-pressed',String(state.fx.contrast));recomputeFX()};
  darkTgl.onclick=()=>{state.fx.dark=!state.fx.dark;darkTgl.classList.toggle('active',state.fx.dark);darkTgl.setAttribute('aria-pressed',String(state.fx.dark));recomputeFX()};

  shutterBtn.onclick=()=>{if(frozen)return;if(video.readyState>=2){drawFrom(video);asciiText=asciiFrom(video)};if(rafId){cancelAnimationFrame(rafId);rafId=null}try{if(video.srcObject){video.srcObject.getTracks().forEach(t=>t.stop())}}catch{}frozen=true;composer.style.display='block'};
  backBtn.onclick=()=>{location.href='/'};

  function showToast(msg,redirect=true){toast.textContent=msg;toast.classList.add('show');if(redirect){setTimeout(()=>{location.href='/'},900)}else{setTimeout(()=>{toast.classList.remove('show')},1500)}}
  function currentCodif(){const lbl=rampEl.options[rampEl.selectedIndex]?.text||'';if(/Básico/i.test(lbl))return'Basico';if(/Denso/i.test(lbl))return'Denso';if(/Números/i.test(lbl))return'Numeros';if(/Bloques/i.test(lbl))return'Bloques';return lbl.trim()||'Desconocido'}
  function getUser(){return localStorage.getItem('user_nombre')||''}

  sendBtn.onclick=async()=>{
    const user=getUser();
    if(!user){showToast('Sesión no iniciada.',true);return}
    if(!asciiText){
      if(video.readyState>=2){asciiText=asciiFrom(video)}else{showToast('No hay imagen capturada.',false);return}
    }
    const codif=currentCodif();
    const nota=(composeTxt.value||'').trim();
    const asciiDB=asciiWithMarkers(asciiText);
    const original=sendBtn.textContent;sendBtn.textContent='Publicando…';sendBtn.disabled=true;
    try{
      const r1=await fetch('/api/imagen',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({txt:asciiDB,codif,user})});
      const j1=await r1.json().catch(()=>({})); if(!r1.ok||!j1.ok){sendBtn.textContent='Error';setTimeout(()=>{sendBtn.textContent=original;sendBtn.disabled=false},1200);return}
      const r2=await fetch('/api/idobtain',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user,txt:asciiDB})});
      const j2=await r2.json().catch(()=>({})); const fotoId=j2?.id;
      if(!r2.ok||!j2.ok||!Number.isFinite(fotoId)){sendBtn.textContent='Error';setTimeout(()=>{sendBtn.textContent=original;sendBtn.disabled=false},1200);return}
      const textForPost=`f(${fotoId})`+(nota?nota:'');
      const r3=await fetch('/api/post',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({op:'create',user,text:textForPost})});
      const j3=await r3.json().catch(()=>({}));
      if(r3.ok&&j3.ok){sendBtn.textContent='Publicado';setTimeout(()=>{location.href='/'},1000)}else{sendBtn.textContent='Error';setTimeout(()=>{sendBtn.textContent=original;sendBtn.disabled=false},1200)}
    }catch{sendBtn.textContent='Error';setTimeout(()=>{sendBtn.textContent=original;sendBtn.disabled=false},1200)}
  };

  function constraintsFor(facing){
    return [
      {video:{facingMode:{exact:facing},width:{ideal:4096},height:{ideal:2160}},audio:false},
      {video:{facingMode:{exact:facing},width:{ideal:2560},height:{ideal:1440}},audio:false},
      {video:{facingMode:{ideal:facing},width:{ideal:1920},height:{ideal:1080}},audio:false},
      {video:{facingMode:facing},audio:false}
    ]
  }

  async function startCamera(facing='environment'){
    try{
      if(video.srcObject){video.srcObject.getTracks().forEach(t=>t.stop())}
      let stream=null;
      for(const c of constraintsFor(facing)){try{stream=await navigator.mediaDevices.getUserMedia(c);break}catch{}}
      if(!stream)throw new Error('No stream');
      const track=stream.getVideoTracks()[0];
      try{await track.applyConstraints({width:{ideal:2560},height:{ideal:1440}})}catch{}
      video.srcObject=stream;
      await video.play();
      const st=track.getSettings?.()||{};
      const vw=st.width||video.videoWidth||640;
      const vh=st.height||video.videoHeight||480;
      const w=Math.floor(vw*qualityScale);
      const h=Math.floor(vh*qualityScale);
      setInternalSize(w,h);
      if(!rafId)loop();
    }catch(err){
      if(facing==='environment'){startCamera('user');return}
      setInternalSize(640,480)
    }
  }

  setInternalSize(640,480);
  startCamera('environment');
})();
</script>
</body>
</html>

