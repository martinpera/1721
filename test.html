<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Test Notificaciones 1721</title>
<style>
  html,body{margin:0;padding:0;font-family:system-ui,Inter,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f6f5f3;color:#111}
  .wrap{max-width:560px;margin:0 auto;padding:24px}
  h1{font-size:22px;margin:0 0 8px}
  p{margin:0 0 14px;color:#555}
  .card{background:#fff;border:1px solid #e6e2da;border-radius:14px;padding:16px}
  .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
  button{border:none;background:#111;color:#fff;border-radius:10px;padding:12px 14px;font-weight:700;cursor:pointer}
  .ghost{background:#fff;color:#111;border:1px solid #e6e2da}
  .stat{margin-top:10px;font-size:14px;color:#333}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Notificaciones 1721</h1>
    <p>Programá una notificación diaria a las 11:30 (hora local).</p>
    <div class="row">
      <button id="enableBtn">Habilitar notificaciones</button>
      <button id="testBtn" class="ghost">Probar ahora</button>
    </div>
    <div id="status" class="stat">Estado: esperando permiso…</div>
    <div id="next" class="stat">Próximo envío: —</div>
  </div>
</div>
<script>
  const statusEl=document.getElementById('status');
  const nextEl=document.getElementById('next');
  const enableBtn=document.getElementById('enableBtn');
  const testBtn=document.getElementById('testBtn');

  function fmt(date){
    const dd=String(date.getDate()).padStart(2,'0');
    const mm=String(date.getMonth()+1).padStart(2,'0');
    const hh=String(date.getHours()).padStart(2,'0');
    const mi=String(date.getMinutes()).padStart(2,'0');
    return `${dd}/${mm} ${hh}:${mi}`;
  }

  function computeNext(hour,minute){
    const now=new Date();
    const target=new Date();
    target.setHours(hour,minute,0,0);
    if(target<=now) target.setDate(target.getDate()+1);
    return target;
  }

  function scheduleDaily(hour,minute){
    const target=computeNext(hour,minute);
    const delay=target-Date.now();
    nextEl.textContent=`Próximo envío: ${fmt(target)}`;
    setTimeout(()=>{
      try{new Notification('1721',{body:'Recordatorio diario 11:30'})}catch{}
      scheduleDaily(hour,minute);
    },delay);
  }

  async function ensurePermission(){
    if(!('Notification'in window)){statusEl.textContent='Estado: este navegador no soporta notificaciones';return false}
    let perm=Notification.permission;
    if(perm==='default'){try{perm=await Notification.requestPermission()}catch{}}
    if(perm==='granted'){statusEl.textContent='Estado: permiso concedido';return true}
    statusEl.textContent='Estado: permiso denegado';
    return false;
  }

  enableBtn.addEventListener('click',async()=>{
    const ok=await ensurePermission();
    if(ok){
      try{new Notification('1721',{body:'Notificaciones activadas'})}catch{}
      scheduleDaily(11,00);
    }
  });

  testBtn.addEventListener('click',async()=>{
    const ok=await ensurePermission();
    if(ok){
      try{new Notification('1721',{body:'Prueba inmediata'})}catch{}
    }
  });

  window.addEventListener('load',async()=>{
    if(Notification && Notification.permission==='granted'){
      statusEl.textContent='Estado: permiso concedido';
      scheduleDaily(11,00);
    }else{
      statusEl.textContent='Estado: tocá “Habilitar notificaciones”';
    }
  });
</script>
</body>
</html>
