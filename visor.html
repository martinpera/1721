<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
<title>Visor</title>
<link rel="icon" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi_hzdAeGD1r9dY8htUSrH5WyLWPR4Xw3G390Nxfsl5zSXl9rnEuK7LG3GRHlvhFyhpzP2vyix-QncMJxnyx0bBimWxKk7ZU1-lzG410NMxtPXH4H7R6QxoUcEJ7uPisB2VyWuANC5O31ArDgOgNgnnQRAWV_TPhB-F7d8DuqWo3PRTNi_vPQ2oHJBi3vp0/s1890/logo.png" type="image/png">
<style>
  :root{--bg:#000;--ink:#eaeaea;--line:#1a1a1a;--header-h:56px}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{background:var(--bg);color:var(--ink);font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;overflow:hidden;touch-action:manipulation}
  header.top{position:fixed;z-index:10;top:0;left:0;right:0;height:56px;display:grid;grid-template-columns:44px 1fr auto;align-items:center;gap:8px;padding:0 10px;border-bottom:1px solid var(--line);background:#000}
  .btn{font-size:12px;color:#eaeaea;background:#111;border:1px solid #2b2b2b;border-radius:10px;height:32px;min-width:36px;display:flex;align-items:center;justify-content:center;cursor:pointer;padding:0 10px}
  .title{justify-self:center;font-size:14px;color:#eaeaea;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .stage{position:fixed;z-index:1;top:calc(var(--header-h) + 8px);left:8px;right:8px;bottom:8px;display:grid;place-items:center;overflow:hidden;background:#000}
  canvas#art{display:block;background:#000;image-rendering:auto;transition:filter .15s ease;filter:grayscale(1)}
  .loading{position:fixed;z-index:2;top:calc(var(--header-h) + 8px);left:8px;right:8px;bottom:8px;display:grid;place-items:center;background:#000}
  .hidden{display:none}
</style>
</head>
<body>
  <header class="top">
    <button id="backBtn" class="btn" aria-label="Volver">
      <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"></path></svg>
    </button>
    <div id="headerMeta" class="title"></div>
    <div style="display:flex;gap:8px">
      <button id="blurBtn" class="btn" aria-pressed="false">Blur</button>
    </div>
  </header>

  <div class="stage" id="stage">
    <canvas id="art"></canvas>
  </div>

  <div id="loading" class="loading" aria-live="polite">
    <svg width="40" height="40" viewBox="0 0 50 50" role="img" aria-label="Cargando">
      <circle cx="25" cy="25" r="20" stroke="#2b2b2b" stroke-width="6" fill="none"/>
      <path d="M25 5 a20 20 0 0 1 0 40" stroke="#eaeaea" stroke-width="6" fill="none" stroke-linecap="round">
        <animateTransform attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.9s" repeatCount="indefinite"/>
      </path>
    </svg>
  </div>

<script>
(function(){
  const canvas=document.getElementById('art');
  const ctx=canvas.getContext('2d',{alpha:false});
  const stage=document.getElementById('stage');
  const loading=document.getElementById('loading');
  const headerMeta=document.getElementById('headerMeta');
  const backBtn=document.getElementById('backBtn');
  const blurBtn=document.getElementById('blurBtn');

  const IS_MOBILE=/iPhone|iPad|Android/i.test(navigator.userAgent)||Math.min(innerWidth,innerHeight)<=820;
  const MAX_SIDE=8192, MAX_AREA=16777216, SAFE_PAD=2, MIN_FONT_PX=6, BASE_FONT_PX_DEFAULT=16;
  const MAX_DPR=/(iPhone|iPad)/i.test(navigator.userAgent)?2:3;

  const LETTER_SPACING_EM=IS_MOBILE?-0.06:-0.10;
  const LINE_HEIGHT=IS_MOBILE?0.98:0.74;

  let lines=[], content=null;

  ['gesturestart','gesturechange','gestureend','dblclick'].forEach(evt=>{
    document.addEventListener(evt,e=>{e.preventDefault()},{passive:false});
  });
  document.addEventListener('wheel',e=>{if(e.ctrlKey||e.metaKey)e.preventDefault()},{passive:false});

  function setHeaderH(){
    const h=(document.querySelector('header.top')?.offsetHeight||56);
    document.documentElement.style.setProperty('--header-h',h+'px');
  }
  setHeaderH();

  function nextFrame(){return new Promise(r=>requestAnimationFrame(()=>requestAnimationFrame(r)))}
  function readTemp(){try{const raw=localStorage.getItem('temp_foto');if(!raw)return null;const obj=JSON.parse(raw);if(obj&&obj.exp&&Date.now()>obj.exp)return null;return obj}catch{return null}}
  async function fetchFoto(id){
    const r=await fetch('/api/obtenerimg',{method:'POST',headers:{'Content-Type':'application/json','Accept':'application/json','Cache-Control':'no-store'},body:JSON.stringify({id})});
    if(!r.ok)throw new Error('No se pudo obtener la imagen');
    const j=await r.json(); if(!j||!j.ok||!j.foto)throw new Error(j?.message||'No encontrado'); return j.foto;
  }
  function parseWithMarkers(s){
    const out=[], re=/X\*{5}([\s\S]*?)\*{5}X/g; let m, any=false;
    while((m=re.exec(s))!==null){any=true;out.push(m[1])}
    if(any)return out;
    return String(s).replace(/\r\n/g,'\n').split('\n');
  }
  function trimVertical(src){
    let a=0,b=src.length-1;
    while(a<=b&&/^\s*$/.test(src[a]))a++;
    while(b>=a&&/^\s*$/.test(src[b]))b--;
    return src.slice(a,b+1);
  }
  function stageSize(){
    const headerH=(document.querySelector('header.top')?.offsetHeight||56);
    const cw=Math.max(1,innerWidth-16);
    const ch=Math.max(1,innerHeight-headerH-16);
    return {cw,ch};
  }

  function measureAt(fontPx){
    ctx.font=`${fontPx}px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace`;
    ctx.textBaseline='top';
    const cw=ctx.measureText('M').width||fontPx*0.6;
    const stepX=Math.max(0.1,cw+LETTER_SPACING_EM*fontPx);
    const stepY=Math.max(1,fontPx*LINE_HEIGHT);
    const rows=lines.length;
    let maxCols=0; for(const ln of lines){if(ln.length>maxCols)maxCols=ln.length}
    const w=maxCols>0?(stepX*(maxCols-1)+cw):1;
    const h=Math.max(1,rows*stepY);
    return {w,h,cw,stepX,stepY,maxCols,rows,fontPx};
  }

  function pickSafeFontPx(startPx){
    let px=Math.max(MIN_FONT_PX,startPx|0);
    let dpr=Math.max(1,Math.min(MAX_DPR,window.devicePixelRatio||1));
    for(let i=0;i<40;i++){
      const m=measureAt(px);
      const W=Math.ceil(m.w*dpr), H=Math.ceil(m.h*dpr), area=W*H;
      if(W<=MAX_SIDE && H<=MAX_SIDE && area<=MAX_AREA) return {px,dpr,metrics:m};
      px=Math.max(MIN_FONT_PX,Math.floor(px*0.9));
    }
    return {px:MIN_FONT_PX,dpr:Math.max(1,Math.min(MAX_DPR,window.devicePixelRatio||1)),metrics:measureAt(MIN_FONT_PX)};
  }

  function renderIntrinsic(){
    const pick=pickSafeFontPx(BASE_FONT_PX_DEFAULT);
    const dpr=pick.dpr;
    content=pick.metrics;
    const W=Math.max(1,Math.ceil(content.w*dpr));
    const H=Math.max(1,Math.ceil(content.h*dpr));
    canvas.width=W; canvas.height=H;
    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.fillStyle='#000';
    ctx.fillRect(0,0,content.w,content.h);
    ctx.fillStyle=(getComputedStyle(document.documentElement).getPropertyValue('--ink')||'#eaeaea').trim()||'#eaeaea';
    const desktop=!IS_MOBILE;
    ctx.font=`${content.fontPx}px ${desktop?'600 ':''}ui-monospace, SFMono-Regular, Menlo, Consolas, monospace`;
    ctx.textBaseline='top';
    const stepX=content.stepX, stepY=content.stepY;
    for(let y=0;y<lines.length;y++){
      const line=lines[y]; const py=Math.round(y*stepY);
      for(let x=0;x<line.length;x++){
        const px=Math.round(x*stepX);
        ctx.fillText(line[x],px,py);
      }
    }
    canvas.style.width=Math.ceil(content.w)+'px';
    canvas.style.height=Math.ceil(content.h)+'px';
    applyShrinkScale();
  }

  function applyShrinkScale(){
    if(!content)return;
    const {cw,ch}=stageSize();
    const availW=Math.max(1,cw- SAFE_PAD*2);
    const availH=Math.max(1,ch- SAFE_PAD*2);
    const scale=Math.min(1, availW/content.w, availH/content.h);
    canvas.style.width=Math.floor(content.w*scale)+'px';
    canvas.style.height=Math.floor(content.h*scale)+'px';
  }

  function handleViewportChange(){
    setHeaderH();
    applyShrinkScale();
  }

  function showLoaded(){loading.classList.add('hidden')}
  function showError(msg){
    lines=[msg||'No se pudo cargar'];
    renderIntrinsic();
    showLoaded();
  }

  async function init(){
    try{
      const tmp=readTemp();
      if(!tmp||!tmp.id){headerMeta.textContent=''; showError('Nada para mostrar'); return}
      const f=await fetchFoto(tmp.id);
      const user=f.usuario?('@'+f.usuario):'@anon';
      const fmt=f.codif?String(f.codif):'';
      headerMeta.textContent=fmt?`${user} Â· formato:"${fmt}"`:user;
      const asciiRaw=String(f.txt||'');
      lines=trimVertical(parseWithMarkers(asciiRaw));
      await nextFrame();
      renderIntrinsic();
      showLoaded();
      addEventListener('resize', ()=>requestAnimationFrame(handleViewportChange));
      addEventListener('orientationchange', ()=>setTimeout(()=>requestAnimationFrame(handleViewportChange),140));
      if(window.visualViewport){visualViewport.addEventListener('resize', ()=>requestAnimationFrame(handleViewportChange))}
    }catch(e){
      headerMeta.textContent='Error';
      showError('No se pudo cargar');
    }
  }

  backBtn.onclick=()=>{history.length>1?history.back():location.href='/'};
  blurBtn.onclick=()=>{
    const on=blurBtn.getAttribute('aria-pressed')==='true'?false:true;
    blurBtn.setAttribute('aria-pressed',String(on));
    blurBtn.classList.toggle('on',on);
    canvas.style.filter=on?'grayscale(1) blur(1.2px) brightness(1.5) contrast(1.05)':'grayscale(1)';
  };

  if(document.readyState==='loading')document.addEventListener('DOMContentLoaded',init);else init();
})();
</script>
</body>
</html>
















