<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Visor</title>
<link rel="icon" href="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEi_hzdAeGD1r9dY8htUSrH5WyLWPR4Xw3G390Nxfsl5zSXl9rnEuK7LG3GRHlvhFyhpzP2vyix-QncMJxnyx0bBimWxKk7ZU1-lzG410NMxtPXH4H7R6QxoUcEJ7uPisB2VyWuANC5O31ArDgOgNgnnQRAWV_TPhB-F7d8DuqWo3PRTNi_vPQ2oHJBi3vp0/s1890/logo.png" type="image/png">
<style>
  :root{--bg:#0a0a0a;--ink:#eaeaea;--line:#1a1a1a;--ring:#2b2b2b;--ls:-0.06em}
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{background:var(--bg);color:var(--ink);font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;overflow:hidden}
  .shell{height:100svh;padding:env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left);display:grid;grid-template-rows:56px 1fr;gap:8px}
  header.top{display:grid;grid-template-columns:44px 1fr 44px;align-items:center;padding:0 10px;border-bottom:1px solid var(--line)}
  .btn{font-size:12px;color:var(--ink);background:#111;border:1px solid var(--ring);border-radius:10px;height:32px;width:36px;display:flex;align-items:center;justify-content:center;cursor:pointer}
  .title{justify-self:center;font-size:14px;color:#eaeaea;text-align:center;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .stage{height:100%;display:flex;align-items:center;justify-content:center;overflow:hidden;padding:0 10px}
  .frame{background:#000;border:1px solid var(--line);border-radius:14px;padding:10px;max-width:100%;max-height:100%;display:flex;align-items:center;justify-content:center;overflow:hidden;margin:auto;width:100%;height:100%}
  .artWrap{display:flex;align-items:center;justify-content:center}
  pre.art{margin:0;color:#eaeaea;background:#000;white-space:pre;letter-spacing:var(--ls);tab-size:2;text-align:center}
  .loading{position:fixed;inset:56px 0 0 0;display:grid;place-items:center}
  .hidden{display:none}
  .sr{position:absolute;left:-9999px;top:-9999px}
</style>
</head>
<body>
  <div class="shell">
    <header class="top">
      <button id="backBtn" class="btn" aria-label="Volver">
        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"></path></svg>
      </button>
      <div id="headerMeta" class="title"></div>
      <div></div>
    </header>

    <div class="stage" id="stage">
      <div class="frame" id="frame" style="display:none">
        <div id="artWrap" class="artWrap">
          <pre id="art" class="art"></pre>
        </div>
      </div>
    </div>
  </div>

  <div id="loading" class="loading" aria-live="polite">
    <svg width="40" height="40" viewBox="0 0 50 50" role="img" aria-label="Cargando">
      <circle cx="25" cy="25" r="20" stroke="#2b2b2b" stroke-width="6" fill="none"/>
      <path d="M25 5 a20 20 0 0 1 0 40" stroke="#eaeaea" stroke-width="6" fill="none" stroke-linecap="round">
        <animateTransform attributeName="transform" type="rotate" from="0 25 25" to="360 25 25" dur="0.9s" repeatCount="indefinite"/>
      </path>
    </svg>
  </div>

<script>
(function(){
  const art=document.getElementById('art');
  const frame=document.getElementById('frame');
  const stage=document.getElementById('stage');
  const loading=document.getElementById('loading');
  const headerMeta=document.getElementById('headerMeta');
  const backBtn=document.getElementById('backBtn');

  const probe=document.createElement('span');
  probe.className='art sr';
  probe.textContent='M';
  document.body.appendChild(probe);

  let lines=[];

  let baseStretch = window.innerWidth <= 768 ? 1.5 : 1.5;
  let STRETCH=parseFloat(new URLSearchParams(location.search).get('stretch'))||
              parseFloat(localStorage.getItem('ascii_stretch'))||
              baseStretch;

  function readTemp(){try{const raw=localStorage.getItem('temp_foto');if(!raw)return null;const obj=JSON.parse(raw);if(obj&&obj.exp&&Date.now()>obj.exp)return null;return obj}catch{return null}}
  async function fetchFoto(id){
    const r=await fetch('/api/obtenerimg',{method:'POST',headers:{'Content-Type':'application/json','Accept':'application/json','Cache-Control':'no-store'},body:JSON.stringify({id})});
    if(!r.ok)throw new Error('No se pudo obtener la imagen');
    const j=await r.json(); if(!j||!j.ok||!j.foto)throw new Error(j?.message||'No encontrado'); return j.foto;
  }

  function parseWithMarkers(s){
    const out=[], re=/X\*{5}([\s\S]*?)\*{5}X/g; let m, any=false;
    while((m=re.exec(s))!==null){ any=true; out.push(m[1]) }
    if(any) return out;
    return s.replace(/\r\n/g,'\n').split('\n');
  }

  function trimVertical(src){
    let a=0,b=src.length-1;
    while(a<=b && /^\s*$/.test(src[a])) a++;
    while(b>=a && /^\s*$/.test(src[b])) b--;
    return src.slice(a,b+1);
  }

  function innerBoxPaddingAndBorder(el){
    const cs=getComputedStyle(el);
    const padX=parseFloat(cs.paddingLeft)+parseFloat(cs.paddingRight);
    const padY=parseFloat(cs.paddingTop)+parseFloat(cs.paddingBottom);
    const borX=parseFloat(cs.borderLeftWidth)+parseFloat(cs.borderRightWidth);
    const borY=parseFloat(cs.borderTopWidth)+parseFloat(cs.borderBottomWidth);
    return {padX,padY,borX,borY};
  }

  function contentSize(){
    const r=art.getBoundingClientRect();
    return {w:r.width,h:r.height};
  }

  function setFont(px){
    art.style.fontSize=px+'px';
    probe.style.fontSize=px+'px';
    const cw=probe.getBoundingClientRect().width||px;
    const lh=(cw/px)*STRETCH;
    art.style.lineHeight=lh.toFixed(5);
  }

  function fitAndScale(){
    if(!lines.length) return;
    art.textContent=lines.join('\n');

    const {padX,padY,borX,borY}=innerBoxPaddingAndBorder(frame);
    const sb=stage.getBoundingClientRect();

    const availW=Math.max(40, sb.width - (borX + padX) - 2);
    const availH=Math.max(40, sb.height - (borY + padY) - 2);

    let lo=6, hi=512, best=6;
    while(lo<=hi){
      const mid=(lo+hi)>>1;
      setFont(mid);
      const {w,h}=contentSize();
      if(w<=availW && h<=availH){best=mid;lo=mid+1}else{hi=mid-1}
    }

    setFont(Math.max(6,best-1));

    let safe=0;
    while(safe<14){
      const {w,h}=contentSize();
      if(w<=availW && h<=availH) break;
      const cur=parseFloat(getComputedStyle(art).fontSize)||best;
      setFont(Math.max(6,cur-1));
      safe++;
    }
  }

  function showLoaded(){
    frame.style.display='flex';
    loading.classList.add('hidden');
  }

  function showError(msg){
    art.textContent=msg||'No se pudo cargar';
    lines=[msg||'No se pudo cargar'];
    showLoaded();
    fitAndScale();
  }

  function mkRedraw(){
    let ticking=false;
    return ()=>{if(ticking)return; ticking=true; requestAnimationFrame(()=>{ticking=false; fitAndScale()})};
  }

  async function init(){
    const tmp=readTemp();
    if(!tmp||!tmp.id){headerMeta.textContent=''; showError('Nada para mostrar'); return}
    try{
      const f=await fetchFoto(tmp.id);
      const user=f.usuario?('@'+f.usuario):'@anon';
      const fmt=f.codif?String(f.codif):'';
      headerMeta.textContent=fmt?`${user} Â· formato:"${fmt}"`:user;

      const asciiRaw=String(f.txt||'');
      lines=trimVertical(parseWithMarkers(asciiRaw));

      showLoaded();
      fitAndScale();
      requestAnimationFrame(()=>requestAnimationFrame(fitAndScale));

      const redraw=mkRedraw();
      window.addEventListener('resize', redraw);
      window.addEventListener('orientationchange', ()=>setTimeout(redraw,140));
      if(window.visualViewport){visualViewport.addEventListener('resize', redraw)}
      const ro=new ResizeObserver(redraw);
      ro.observe(stage);
    }catch(e){
      headerMeta.textContent='Error';
      showError('No se pudo cargar');
    }
  }

  backBtn.onclick=()=>{history.length>1?history.back():location.href='/'};

  init();
})();
</script>
</body>
</html>
